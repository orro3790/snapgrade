{
	"nodes": [
		{
			"parameters": {
				"conditions": {
					"string": [
						{
							"value1": "={{ $json.message.text }}",
							"value2": "/start",
							"operation": "startsWith"
						}
					]
				}
			},
			"name": "Is Start Command",
			"type": "n8n-nodes-base.if",
			"typeVersion": 1,
			"position": [-420, 220]
		},
		{
			"parameters": {
				"jsCode": "// Extract link code from /start command\nconst text = $input.item.json.message.text;\nconst parts = text.split(' ');\n\nif (parts.length !== 2) {\n  return {\n    json: {\n      error: 'Invalid link code format'\n    }\n  };\n}\n\nreturn {\n  json: {\n    linkCode: parts[1]\n  }\n};"
			},
			"name": "Extract Link Code",
			"type": "n8n-nodes-base.code",
			"typeVersion": 1,
			"position": [-220, 220]
		},
		{
			"parameters": {
				"operation": "get",
				"collection": "users",
				"options": {},
				"where": {
					"conditions": [
						{
							"field": "metadata.telegramLinkCode",
							"operator": "equal",
							"value": "={{ $json.linkCode }}"
						}
					],
					"options": {
						"caseSensitive": true
					}
				}
			},
			"name": "Find User By Link Code",
			"type": "n8n-nodes-base.googleFirestore",
			"typeVersion": 2,
			"position": [-20, 220],
			"credentials": {
				"googleFirestoreOAuth2Api": {
					"id": "YOUR_FIRESTORE_CRED_ID",
					"name": "Firestore Account"
				}
			}
		},
		{
			"parameters": {
				"conditions": {
					"boolean": [
						{
							"value1": "={{ $json.data[0] }}",
							"value2": true,
							"operation": "exists"
						}
					]
				}
			},
			"name": "Valid Link Code",
			"type": "n8n-nodes-base.if",
			"typeVersion": 1,
			"position": [180, 220]
		},
		{
			"parameters": {
				"operation": "update",
				"collection": "users",
				"documentId": "={{ $('Find User By Link Code').item.json.data[0].id }}",
				"fields": {
					"values": [
						{
							"field": "metadata.telegramId",
							"value": "={{ $('Telegram Trigger').item.json.message.from.id }}"
						},
						{
							"field": "metadata.telegramLinkCode",
							"value": null
						},
						{
							"field": "metadata.telegramLinkExpiry",
							"value": null
						}
					]
				},
				"options": {}
			},
			"name": "Update User",
			"type": "n8n-nodes-base.googleFirestore",
			"typeVersion": 2,
			"position": [380, 220],
			"credentials": {
				"googleFirestoreOAuth2Api": {
					"id": "YOUR_FIRESTORE_CRED_ID",
					"name": "Firestore Account"
				}
			}
		},
		{
			"parameters": {
				"chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
				"text": "✅ Account linked successfully!\n\nYou can now send photos of documents for processing.",
				"additionalFields": {
					"parse_mode": "HTML"
				}
			},
			"name": "Send Success Message",
			"type": "n8n-nodes-base.telegram",
			"typeVersion": 1.2,
			"position": [580, 220],
			"credentials": {
				"telegramApi": {
					"id": "YOUR_TELEGRAM_CRED_ID",
					"name": "Telegram account"
				}
			}
		},
		{
			"parameters": {
				"chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
				"text": "❌ Invalid or expired link code. Please generate a new link from your Snapgrade account settings.",
				"additionalFields": {
					"parse_mode": "HTML"
				}
			},
			"name": "Send Error Message",
			"type": "n8n-nodes-base.telegram",
			"typeVersion": 1.2,
			"position": [180, 400],
			"credentials": {
				"telegramApi": {
					"id": "YOUR_TELEGRAM_CRED_ID",
					"name": "Telegram account"
				}
			}
		}
	],
	"connections": {
		"Telegram Trigger": {
			"main": [
				[
					{
						"node": "Is Start Command",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Is Start Command": {
			"main": [
				[
					{
						"node": "Extract Link Code",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Check User Auth",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Extract Link Code": {
			"main": [
				[
					{
						"node": "Find User By Link Code",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Find User By Link Code": {
			"main": [
				[
					{
						"node": "Valid Link Code",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Valid Link Code": {
			"main": [
				[
					{
						"node": "Update User",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Send Error Message",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Update User": {
			"main": [
				[
					{
						"node": "Send Success Message",
						"type": "main",
						"index": 0
					}
				]
			]
		}
	}
}
